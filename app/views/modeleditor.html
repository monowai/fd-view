<!--
  ~
  ~  Copyright (c) 2012-2016 "FlockData LLC"
  ~
  ~  This file is part of FlockData.
  ~
  ~  FlockData is free software: you can redistribute it and/or modify
  ~  it under the terms of the GNU General Public License as published by
  ~  the Free Software Foundation, either version 3 of the License, or
  ~  (at your option) any later version.
  ~
  ~  FlockData is distributed in the hope that it will be useful,
  ~  but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~  GNU General Public License for more details.
  ~
  ~  You should have received a copy of the GNU General Public License
  ~  along with FlockData.  If not, see <http://www.gnu.org/licenses/>.
  -->


<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    Model
    <small>Content that describe the data you want to import</small>
  </h1>
  <ol class="breadcrumb">
    <li><a ui-sref="welcome"><i class="fa fa-home"></i> Home</a></li>
    <li class="active">Model</li>
  </ol>
</section>

<!-- Main content -->
<section class="content">
  <div class="row">
    <div class="col-md-12">
      <div class="nav-tabs-custom">
        <ul class="nav nav-tabs pull-right">
          <li uib-tooltip="Model Settings"><a href data-target="#settings" data-toggle="tab"><i class="fa fa-lg fa-cog"></i></a></li>
          <li uib-tooltip="Source"><a href data-target="#json" data-toggle="tab" ng-click="checkModel()"><i class="fa fa-lg fa-edit"></i></a></li>
          <li uib-tooltip="Structure" class="active" ng-show="canSave()"><a href data-target="#structure" data-toggle="tab" ng-click="updateModel()"><i class="fa fa-lg fa-sitemap"></i></a></li>
          <li uib-tooltip="Data Statistics" ng-show="dataStats"><a href data-target="#stats" data-toggle="tab"><i class="fa fa-lg fa-signal"></i></a></li>
          <li uib-tooltip="Data" ng-show="canSave()"><a href data-target="#sample" data-toggle="tab"><i class="fa fa-lg fa-file-text"></i></a></li>
          <li uib-tooltip="Validation" ng-show="validationResult"><a href data-target="#validate" data-toggle="tab"><i class="fa fa-lg fa-check-square-o"></i></a></li>
          <li uib-dropdown>
            <a href id="action-menu" uib-dropdown-toggle>
            Action <span class="caret"></span></a>
            <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="action-menu">
              <li role="menuitem" ng-show="canSave()"><a href ng-click="save()">Save</a></li>
              <li role="menuitem" ng-show="dataSample"><a href ng-click="validate(dataSample)">Validate</a></li>
              <li role="menuitem" ng-show="validationResult"><a href ng-click="trackResult(validationResult)">Track</a></li>
              <li role="menuitem" ng-show="dataSample"><a href ng-click="cleanSample()">Reload Sample</a></li>
              <li class="divider" ng-show="canSave()"></li>
              <li role="menuitem"><a href ng-click="cancel()">Cancel</a></li>
            </ul>
          </li>

          <li class="pull-left header"><i class="fa fa-share-alt"></i> Edit Content Model - {{name}} <i ng-hide="saved()">(not saved)</i> </li>
        </ul>
        <div class="tab-content clearfix">
          <!-- General model settings-->
          <div id="settings" class="tab-pane fade">
            <div class="col-md-6">
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="tagModel" name="tagModel" ng-model="contentModel.tagModel" ng-change="cleanTagModel()"> Tag model
                  </label>
                </div>
              </div>
              <div class="form-group" ng-hide="contentModel.tagModel">
                <label class="control-label">Fortress:</label>
                <fortress-input model="contentModel.fortress.name" class="input-sm"></fortress-input>
              </div>
              <div class="form-group" ng-hide="contentModel.tagModel">
                <label class="control-label">Document Type:</label>
                <doctype-input model="contentModel.documentType.name" class="input-sm" fortress="contentModel.fortress.name" on-select="findModel(contentModel)"></doctype-input>
              </div>
              <div class="form-group" ng-show="contentModel.tagModel">
                <label class="control-label">Code:</label>
                <input type="text" class="form-control input-sm" ng-model="contentModel.code" placeholder="Code" ng-focus="getAllModels()"
                       uib-typeahead="m.code for m in tagModels | filter:$viewValue" typeahead-on-select="findModel(contentModel)" />
              </div>
              <div class="form-group">
                <label class="control-label">Description:</label>
                <input type="text" class="form-control input-sm" ng-model="contentModel.name" placeholder="Description">
              </div>
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="emptyIgnored" name="emptyIgnored" ng-model="contentModel.emptyIgnored"> Ignore empty
                  </label>
                </div>
              </div>
              <div class="form-group" ng-hide="contentModel.tagModel">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="archiveTags" name="archiveTags" ng-model="contentModel.archiveTags"> Archive tags
                  </label>
                </div>
              </div>
              <div class="form-group" ng-hide="contentModel.tagModel">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="entityOnly" name="entityOnly" ng-model="contentModel.entityOnly"> Entity only
                  </label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="trackSuppressed" name="trackSuppressed" ng-model="contentModel.trackSuppressed"> Track suppressed
                  </label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="searchSuppressed" name="searchSuppressed" ng-model="contentModel.searchSuppressed"> Search suppressed
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label class="control-label">Pre-parse Expression:</label>
                <input type="text" class="form-control input-sm" ng-model="contentModel.preParseRowExp" placeholder="Pre-parse row expression">
              </div>
              <div class="form-group" ng-hide="contentModel.tagModel">
                <label class="control-label">Segment Expression:</label>
                <input type="text" class="form-control input-sm" ng-model="contentModel.segmentExpression" placeholder="Segment expression">
              </div>
            </div>

            <div class="col-md-6 fader" ng-show="canSave()">
              <label class="control-label">Next: </label><br>
              <button type="button" class="btn btn-success" ng-click="sampleData()">Upload Sample</button>
              <button type="button" class="btn btn-primary" ng-click="updateModel()">Edit Structure</button>
            </div>

            <div class="col-md-6" ng-show="!!modelToLoad">
              <label class="control-label">This model already exists!</label><br>
              <button type="button" class="btn btn-success" ng-click="loadModel(modelToLoad.key)">Load Existing</button>
            </div>

          </div>

          <!-- View Data Sample -->
          <div id="sample" class="tab-pane fade">
            <div ng-if="!dataSample">
              <div class="row">
                <div class="col-sm-3">
                  <fieldset>
                    <legend>Sample </legend>
                    <div class="row">
                      <div class="form-group">
                        <label for="data-delim" class="col-xs-4 control-label">Delimiter</label>
                        <div class="col-xs-7">
                          <input type="text" class="form-control" id="data-delim" ng-model="delim" ng-init="delim=','">
                        </div>
                      </div>
                      <div class="col-sm-6">
                        <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input type="checkbox" ng-model="ignoreEmpty"> <b>Ignore empty Cols</b>
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6">
                        <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input type="checkbox" ng-model="hasHeader" disabled> <b>Has Header</b>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </div>
                <div class="col-sm-9">
                  <div class="well well-sm">
                    <div class="row">
                      <div class="col-md-12">
                        <div class="file-box" file-box="loadFile($fileContent, $fileName, delim)">
                          <label ng-click="loadPrevious()" ng-show="previouslyLoaded"><strong>Use</strong>
                            <span>uploaded earlier</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="hscroll-table fader" ng-if="!!dataSample">
              <div ag-grid="gridOptions" class="ag-blue" ng-height="200"></div>
            </div>
            <p ng-show="dataSample.length>199"><i>* Only first 200 rows are displayed</i></p>
          </div>

          <div id="stats" class="tab-pane fade">
            <div class="row">
              <div class="col-sm-2">Name</div>
              <div class="col-sm-1">Type</div>
              <div class="col-sm-1">Missing</div>
              <div class="col-sm-8">Statistics</div>
            </div>
            <div role="tablist" class="panel-group">
              <div class="box panel panel-default" ng-repeat="(name, col) in dataStats"
                   ng-class="{'box-warning': contentModel.content[name].tag, 'box-success': contentModel.content[name].callerRef }">
                <div aria-selected class="panel-heading">
                  <h4 class="panel-title">
                    <div class="box-title row stats-panel">
                      <div class="col-sm-2">
                        <div class="label stats-label label-warning col-name" ng-show="contentModel.content[name].tag">Tag</div>
                        <div class="label stats-label label-success col-name" ng-show="contentModel.content[name].callerRef">Primary Key</div>
                        <div class="truncate"><i class="pull-left glyphicon" ng-class="isOpen ? 'glyphicon-chevron-down' : 'glyphicon-chevron-right'"></i>&nbsp;
                        <a href ng-click="showColDef(name)">{{name}}</a></div>
                      </div>
                      <div class="col-sm-1">{{col.type}}</div>
                      <div class="col-sm-1">{{col.missing}}</div>
                      <div class="col-sm-8" ng-if="col.type=='string'" ng-show="col.missing!==dataSample.totalImport">
                        <div class="col-sm-3">
                          <div class="label stats-label label-primary">Least</div>
                          {{col.stats.least[0]}}: {{col.stats.least[1]}}
                        </div>
                        <div class="col-sm-3">
                          <div class="label stats-label label-primary">Most</div>
                          {{col.stats.most[0]}}: {{col.stats.most[1]}}
                        </div>
                        <div class="col-sm-6">
                          <div class="label stats-label label-primary">Values</div>
                          <span>{{col.stats.values | limitTo:3}}</span>
                        </div>
                      </div>
                      <div class="col-sm-7" ng-if="col.type!='string'">
                        <div class="col-sm-2">
                          <div class="label stats-label label-primary">Min</div>
                          {{col.stats.min}}
                        </div>
                        <div class="col-sm-2">
                          <div class="label stats-label label-primary">Max</div>
                          {{col.stats.max}}
                        </div>
                        <div class="col-sm-8">
                          <div class="label stats-label label-primary">Average</div>
                          {{col.stats.mean}}
                        </div>
                      </div>
                    </div>
                  </h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Model structure -->
          <div id="structure" class="tab-pane fade active in">
            <div class="col-md-2 col-xs-6">
              <div class="form-group" >
                <label class="control-label">Layout</label>
                <div class="pull-right">
                  <select ng-model="layout" ng-options="l.name for l in layouts"></select>
                </div>
              </div>

              <label class="control-label">Create</label>

              <button id="coldef" class="btn btn-sm btn-block btn-default" ng-click="createColumn()">Calculated Column</button>
              <button id="tag" class="btn btn-sm btn-block btn-warning" draggable options="{opacity: .5,revert: true}" ng-click="createTag()">Tag</button>
              <button id="alias" class="btn btn-sm btn-block btn-alias" draggable options="{opacity: .5,revert: true}" ng-click="createAlias()">Alias</button>
              <button id="entity" class="btn btn-sm btn-block btn-primary" draggable droppable="buttonDrop" options="{opacity: .5,revert: true}" ng-click="createEntitylink()">Entity Link</button>

              <label uib-dropdown>
                <a href id="list-menu" uib-dropdown-toggle>
                  {{list}} <span class="caret"></span></a>
                <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="list-menu">
                  <li role="menuitem"><a href ng-click="list='Columns'">Columns</a></li>
                  <li role="menuitem"><a href ng-click="list='Tags'">Tags</a></li>
                </ul>
              </label>
              <!--<label class="control-label">Columns</label>-->
              <div ng-height="400" class="scroll-col" ng-show="list==='Columns'">
                <div class="btn-toolbar" id="Columns">
                  <button id="{{col}}" class="btn btn-xs" ng-class="{'btn-warning' : val.tag, 'btn-primary': !val.tag, 'dim': val.persistent===false, 'btn-success':val.callerRef, 'btn-alias': !!val.$$alias}"
                          draggable options="{opacity: .5,revert: true}" style="margin: 2px;" ng-repeat="(col, val) in contentModel.content" ng-click="showColDef(col)" uib-tooltip="{{val.label}}">{{col}}</button>
                </div>
              </div>
              <div ng-height="400" class="scroll-col" ng-show="list==='Tags'">
                <div class="btn-toolbar" id="Tags">
                  <button id="{{tag.id}}" class="btn btn-xs label btn-warning" draggable options="{opacity: .5,revert: true}" style="margin: 2px;"
                          ng-repeat="tag in tags" ng-click="showColDef(tag.id,{openAsTag: true})">{{tag.label}}</button>
                </div>
              </div>
            </div>
            <div class="col-md-10" droppable="handleDrop">
              <cytoscape class="modeler" elements="modelGraph" layout="layout" styles="styles" selected-nodes="nodes" ng-height="180" on-edge="nodeLink(source, target)" qtip="qtip"></cytoscape>
            </div>
          </div>

          <!-- Edit JSON -->
          <div id="json" class="tab-pane fade">
            <div ng-jsoneditor="onEditorLoad" ng-model="contentModel" options="editorOptions" ng-height="180"></div>
          </div>

          <div id="validate" class="tab-pane fade">
            <div class="hscroll-table fader" ng-if="!!validationResult">
              <div ag-grid="valGridOptions" class="ag-blue" ng-height="200"></div>
            </div>
          </div>
        </div>
        <br>
      </div>
    </div>
  </div>
</section>

<script type="text/ng-template" id="edit-coldef.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cancel()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">{{caption}} - {{name}}</h4>
  </div>
  <form name="colDefForm" class="form-horizontal" novalidate>
    <div class="modal-body">
      <uib-tabset class="nav-tabs-custom" active="tab">
        <uib-tab heading="Column" ng-hide="openAsTag">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="target" class="col-sm-3 control-label">Store as: </label>
                <div class="col-sm-9">
                  <input type="text" id="target" name="target" class="form-control" ng-model="cd.target" placeholder="Rename the source column to..." autofocus>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="dataType" class="col-sm-3 control-label">Data Type: </label>
                <div class="col-sm-9">
                  <select id="dataType" class="form-control" ng-model="cd.dataType" ng-options="dt as dt for dt in dataTypes" ng-change="checkFormat()">
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="row" ng-show="cd.dataType==='date'">
            <div class="col-md-6" >
              <div class="form-group">
                <label for="dateFormat" class="col-sm-3 control-label">Date Format: </label>
                <div class="col-sm-9">
                  <select id="dateFormat" class="form-control" ng-model="cd.dateFormat" ng-options="df as df for df in dateFormats" ng-required="cd.dataType==='date'">
                  </select>
                </div>
              </div>
            </div>
            <div class="col-md-6" ng-show="cd.dateFormat==='custom'">
              <div class="form-group">
                <label for="customDate" class="col-sm-3 control-label">Custom Date: </label>
                <div class="col-sm-9">
                  <input type="text" id="customDate" name="customDate" class="form-control" ng-model="cd.customDate" ng-required="cd.dateFormat==='custom'" placeholder="Select your date format like 'yyyy-MM-dd' ">
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <div class="form-group">
                <div class="col-sm-offset-1 col-xs-4 col-sm-3" ng-hide="tagModel">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isPK" name="isPK" ng-model="cd.callerRef"> <b>Primary Key</b>
                    </label>
                  </div>
                </div>
                <div class="col-xs-4 col-sm-2" ng-hide="tagModel">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isTitle" name="isTitle" ng-model="cd.title"> <b>Entity Name</b>
                    </label>
                  </div>
                </div>
                <div class="col-xs-4 col-sm-2" ng-hide="tagModel">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isDescr" name="isDescr" ng-model="cd.description"> <b>Search Description</b>
                    </label>
                  </div>
                </div>
                <div class="col-xs-4 col-sm-2">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isTag" name="isTag" ng-model="cd.tag" ng-change="convertTag(cd)"> <b>Tag</b>
                    </label>
                  </div>
                </div>
                <div class="col-xs-4 col-sm-2">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isAlias" name="isAlias" ng-model="isAlias" ng-change="toggleAlias(isAlias)"> <b>Alias</b>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="value" class="col-sm-1 control-label">Value: </label>
                <div class="col-sm-11">
                  <!--<textarea id="value" name="value" class="form-control code" ng-model="cd.value" rows="1" ng-disabled="cd.tag" ng-trim="false" msd-elastic smart-area="codeConf" placeholder="Default is value in the column. You can use a SPeL expression, e.g. #data['colA']+'-'+#data['colB']"></textarea>-->
                  <textcomplete id="value" name="value" message="cd.value" columns="columns" disabled="cd.tag" placeholder="Default is value in the column. You can use a SPeL expression, e.g. #data['colA']+'-'+#data['colB']"></textcomplete>
                </div>
              </div>
            </div>
          </div>
          <div class="row" ng-show="cd.dataType==='date'">
            <div class="col-xs-offset-1 col-md-5">
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="createDate" name="createDate" ng-model="cd.createDate"> <b>Create date</b>
                  </label>
                </div>
              </div>
            </div>
            <div class="col-xs-offset-1 col-md-5">
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="lastupDate" name="lastupDate" ng-model="cd.lastupDate"> <b>Last update date</b>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="row" ng-show="cd.dataType==='string'">
            <div class="col-xs-offset-1 col-md-5">
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="createUser" name="createUser" ng-model="cd.createUser"> <b>Create user</b>
                  </label>
                </div>
              </div>
            </div>
            <div class="col-xs-offset-1 col-md-5">
              <div class="form-group" ng-show="cd.dataType==='string'">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="updateUser" name="updateUser" ng-model="cd.updateUser"> <b>Update user</b>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-offset-1 col-md-5">
              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" id="ignore" name="ignore" ng-model="cd.persistent"> <b>Capture this column</b>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <fieldset ng-show="isAlias || !!cd.$$alias">
            <legend>Alias properties required</legend>
            <div class="row">
              <div class="col-sm-3">
                <label for="tg-alias" class="control-label col-xs-4">Tag</label>
                <div class="input-group col-xs-8">
                  <select id="tg-alias" name="tg-alias" class="form-control" ng-model="cd.$$alias.tag" ng-options="t.id as t.label for t in tags" ng-required="isAlias">
                    <option value="" disabled selected>Select tag</option>
                  </select>
                </div>
              </div>
              <div class="col-sm-4">
                <label for="code-alias" class="control-label col-xs-4">Code</label>
                <div class="input-group col-xs-8">
                  <input type="text" id="code-alias" name="code-alias" class="form-control" ng-model="cd.$$alias.code" ng-required="isAlias" disabled />
                </div>
              </div>
              <div class="col-sm-5">
                <label for="dsc-alias" class="control-label col-xs-4">Description</label>
                <div class="input-group col-xs-8">
                  <input type="text" id="dsc-alias" name="dsc-alias" class="form-control" ng-model="cd.$$alias.description" ng-required="isAlias" />
                </div>
              </div>
            </div>
          </fieldset>

          <fieldset ng-show="!cd.tag && !tagModel">
            <legend>Properties to set into {{entity}} &nbsp;<button type="button" class="btn btn-sm btn-primary" uib-tooltip="Add new" ng-click="addProperty(cd)"><i class="fa fa-plus"></i></button></legend>

            <div class="row" ng-repeat="p in cd.properties">
              <div class="col-md-12">
                <div class="col-md-5 form-group">
                  <label for="tSource" class="control-label col-xs-4">Source</label>
                  <div class="input-group col-xs-8">
                    <select id="tSource" name="pSource" class="form-control" ng-model="p.source" ng-options="c as c for c in columns">
                      <option value="" disabled selected>{{name}}</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="tTarget" class="control-label col-xs-3">Set as</label>
                  <div class="input-group col-xs-9">
                    <input id="tTarget" name="pTarget" type="text" class="form-control" ng-model="p.target"/>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default" ng-click="editProperty(cd.properties, p)" uib-tooltip="Edit"><i class="fa fa-edit"></i></button>
                      </span>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default" ng-click="cd.properties.splice($index,1)" uib-tooltip="Delete"><i class="fa fa-trash"></i></button>
                      </span>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
        </uib-tab>
        <uib-tab heading="{{cd.label}} Properties" disable="!(cd.tag || openAsTag)"  ng-show="(cd.tag || openAsTag)">
          <div class="row">
            <div class="col-md-8">
              <br>
              <div class="form-group">
                <label for="label" class="control-label col-xs-2">Tag Type</label>
                <div class="col-xs-10">
                  <tag-input id="label" model="cd.label"></tag-input>
                </div>
              </div>
              <div class="form-group">
                <label for="tagCode" class="control-label col-xs-2">Code</label>
                <div class="col-xs-10">
                  <textarea id="tagCode" name="tagCode" rows="1" class="form-control" ng-model="cd.code" placeholder="Defaults to column data value" textcomplete="columns" autofocus></textarea>
                </div>
              </div>
              <div class="form-group">
                <label for="nameCol" class="control-label col-xs-2">Name</label>
                <div class="col-xs-10">
                  <!--<textarea id="nameCol" name="nameCol" rows="1" class="form-control" ng-model="cd.name" placeholder="Optional columnName, #data['expression'], or 'literal value'"></textarea>-->
                  <textcomplete id="nameCol" name="nameCol" message="cd.name" columns="columns" placeholder="Optional columnName, #data['expression'], or 'literal value'"></textcomplete>
                </div>
              </div>
              <div class="form-group">
                <label for="prefix" class="control-label col-xs-2">Prefix</label>
                <div class="col-xs-10">
                  <input id="prefix" name="prefix" type="text" class="form-control" ng-model="cd.keyPrefix" placeholder="Optional prefix to a code e.g. us.ma.cambridge vs. uk.ca.cambridge"/>
                </div>
              </div>
              <br>
              <div class="form-group">
                <div class="col-sm-offset-2 col-xs-5">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="mustExist" name="mustExist" ng-model="cd.mustExist"> <b>Must exist</b>
                    </label>
                  </div>
                </div>
                <div class="col-xs-5">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="merge" name="merge" ng-model="cd.merge" ng-checked="true"> <b>Merge if exists</b>
                    </label>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="valIfNull" class="control-label col-xs-3">If not found, set Code to</label>
                <div class="col-xs-9">
                  <input id="valIfNull" name="valIfNull" type="text" class="form-control" ng-model="cd.notFound"/>
                </div>
              </div>
              <div class="form-group" ng-show="openAsTag || !!cd.relationship">
                <label for="relationship" class="control-label col-xs-3">Relationship name</label>
                <div class="col-xs-9 col-sm-7">
                  <!--<input id="relationship" name="relationship" type="text" class="form-control" ng-model="cd.relationship"/>-->
                  <textcomplete id="relationship" name="relationship" message="cd.relationship" columns="columns"></textcomplete>
                </div>
                <div class="col-sm-2 checkbox">
                  <label>
                    <input type="checkbox" name="reverse" ng-model="cd.reverse"> <b>Reverse</b>
                  </label>
                </div>
              </div>
              <div class="form-group">
                <label for="delim" class="control-label col-xs-3">Delimiter</label>
                <div class="col-xs-9 col-sm-7">
                  <input id="delim" name="delim" type="text" class="form-control" ng-model="cd.delimiter"/>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <fieldset>
                <legend>Target Tags  &nbsp;<button type="button" class="btn btn-sm btn-primary" uib-tooltip="Add new" ng-click="addTarget(cd)"><i class="fa fa-plus"></i></button></legend>

                <div ui-tree>
                  <ol ui-tree-nodes="" ng-model="cd.targets" id="tree-root">
                    <li ng-repeat="tag in cd.targets" ui-tree-node ng-include="'targets_renderer.html'"></li>
                  </ol>
                </div>

              </fieldset>
            </div>

            <div class="col-md-12">
              <fieldset>
                <legend>Properties to set into Tag &nbsp;<button type="button" class="btn btn-sm btn-primary" uib-tooltip="Add new" ng-click="addProperty(cd)"><i class="fa fa-plus"></i></button></legend>

                <div class="row" ng-repeat="p in cd.properties">
                  <div class="col-md-6 form-group">
                    <label for="pSource" class="control-label col-xs-4">Source</label>
                    <div class="input-group col-xs-8">
                      <select id="pSource" name="pSource" class="form-control" ng-model="p.source" ng-options="c as c for c in columns">
                        <option value="" disabled selected>{{name}}</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="pTarget" class="control-label col-xs-3">Set as</label>
                    <div class="input-group col-xs-9">
                      <input id="pTarget" name="pTarget" type="text" class="form-control" ng-model="p.target"/>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default" ng-click="editProperty(cd.properties, p)" uib-tooltip="Edit"><i class="fa fa-edit"></i></button>
                      </span>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default" ng-click="cd.properties.splice($index,1)" uib-tooltip="Delete"><i class="fa fa-trash"></i></button>
                      </span>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </uib-tab>
        <uib-tab heading="Relationships" ng-show="cd.tag" ng-hide="!entity">
          <div class="row">
            <div class="col-md-12" ng-show="cd.tag">
              <fieldset>
                <legend>'{{entity}}' Relationships  &nbsp;<button type="button" class="btn btn-sm btn-primary" uib-tooltip="Add new" ng-click="addEntityRel()"><i class="fa fa-plus"></i></button></legend>

                <uib-accordion class="box-group">
                  <div uib-accordion-group ng-repeat="link in cd.entityTagLinks" class="box box-solid fader" ng-init="isOpen = $last" is-open="isOpen">
                    <uib-accordion-heading>
                      <div class="box-title" >{{link.relationshipName}} <i class="pull-right glyphicon" ng-class="isOpen ? 'glyphicon-chevron-down' : 'glyphicon-chevron-right'"></i></div>
                    </uib-accordion-heading>

                    <div class="row">
                      <div class="col-md-6">
                        <label for="rel-name" class="control-label col-xs-4">Relationship name</label>
                        <div class="input-group col-xs-8">
                          <input id="rel-name" name="relName" type="text" class="form-control" ng-model="link.relationshipName">
                        </div>
                      </div>
                      <div class="col-sm-2 form-group">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" id="rel-geo" name="geo" ng-model="link.geo"> <b>Geo</b>
                          </label>
                        </div>
                      </div>
                      <div class="col-sm-2 form-group">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" id="rel-reverse" name="reverse" ng-model="link.reverse" ng-change="cd.reverse=link.reverse"> <b>Reverse</b>
                          </label>
                        </div>
                      </div>
                      <div class="col-sm-2">
                        <div class="box-tools pull-right">
                          <button type="button" class="btn btn-default btn-sm" uib-tooltip="Add Property" ng-click="addProperty(link)"><i class="fa fa-lg fa-plus"></i></button>
                          <button type="button" class="btn btn-default btn-sm" uib-tooltip="Delete Link" ng-click="cd.entityTagLinks.splice($index,1)"><i class="fa fa-lg fa-trash"></i></button>
                        </div>
                      </div>
                    </div>
                    <div class="row" ng-show="!!link.properties">
                      <div class="col-md-12">
                        <fieldset>
                          <legend>Properties</legend>

                          <div class="row" ng-repeat="p in link.properties">
                            <div class="col-md-12">
                              <div class="col-md-5 form-group">
                                <label for="plSource" class="control-label col-xs-4">Source</label>
                                <div class="input-group col-xs-8">
                                  <select id="plSource" name="plSource" class="form-control" ng-model="p.source" ng-options="c as c for c in columns">
                                    <option value="" disabled selected>{{name}}</option>
                                  </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <label for="plTarget" class="control-label col-xs-3">Set as</label>
                                <div class="input-group col-xs-9">
                                  <input id="plTarget" name="plTarget" type="text" class="form-control" ng-model="p.target"/>
                                  <span class="input-group-btn">
                                    <button type="button" class="btn btn-default" ng-click="editProperty(link.properties, p)" uib-tooltip="Edit"><i class="fa fa-edit"></i></button>
                                  </span>
                                  <span class="input-group-btn">
                                    <button type="button" class="btn btn-default" ng-click="link.properties.splice($index,1)" uib-tooltip="Delete"><i class="fa fa-trash"></i></button>
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </fieldset>
                      </div>
                    </div>
                  </div>
                </uib-accordion>
              </fieldset>
            </div>
          </div>
        </uib-tab>
        <uib-tab heading="Entity Links" ng-hide="!entity">
          <div class="row">
            <div class="col-md-12">
              <fieldset>
                <legend class="legend">Existing Entity Links &nbsp;
                  <button type="button" class="btn btn-sm btn-primary" uib-tooltip="Add new" ng-click="addEntityLink()"><i class="fa fa-plus"></i></button>
                </legend>
                <table class="table" ng-show="cd.entityLinks.length>0">
                  <tr>
                    <th><i class="fa fa-external-link" uib-tooltip="Parent"></i></th>
                    <th>Fortress</th>
                    <th>Document Name</th>
                    <th>Relationship</th>
                    <th class="checkbox">
                      <label>
                        <input type="checkbox" name="reverse" ng-model="cd.reverse"> <b>Reverse</b>
                      </label>
                    </th>
                  </tr>
                  <tr ng-repeat="e in cd.entityLinks">
                    <td><label><input type="checkbox" ng-model="e.parent" uib-tooltip="Parent" ng-disabled="!e.parent && entityParentSelected(cd.entityLinks)"> </label></td>
                    <td class="col-xs-4">
                      <fortress-input model="e.fortress" ng-required="true"></fortress-input>
                    </td>
                    <td class="col-xs-4">
                      <doctype-input model="e.documentName" fortress="e.fortress" ng-required="true"></doctype-input>
                    </td>
                    <td class="col-xs-3"><input class="form-control" ng-model="e.relationshipName" ng-required="true" type="text" placeholder="Relationship name"></td>
                    <td>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default btn-sm" ng-click="cd.entityLinks.splice($index,1)" uib-tooltip="Delete"><i class="fa fa-trash"></i></button>
                      </span>
                    </td>
                  </tr>
                </table>
              </fieldset>
            </div>
          </div>
        </uib-tab>
        <uib-tab heading="Geo Data" ng-show="cd.tag || openAsTag">
          <div class="row">
            <div class="col-md-6">
              <fieldset>
                <legend>Geo Data</legend>
                <div class="form-group">
                  <label for="standard" class="control-label col-xs-3">Standard</label>
                  <div class="col-xs-9">
                    <input id="standard" name="standard" type="text" class="form-control" ng-model="cd.geoData.sourceFormat" />
                  </div>
                </div>
                <div class="form-group">
                  <label for="geoX" class="control-label col-xs-3">X</label>
                  <div class="col-xs-9">
                    <input id="geoX" name="geoX" type="text" class="form-control" ng-model="cd.geoData.x" />
                  </div>
                </div>
                <div class="form-group">
                  <label for="geoY" class="control-label col-xs-3">Y</label>
                  <div class="col-xs-9">
                    <input id="geoY" name="geoY" type="text" class="form-control" ng-model="cd.geoData.y" />
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </uib-tab>
      </uib-tabset>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default pull-left" ng-click="cancel('cancel')">Cancel</button>
      <button type="submit" class="btn btn-primary" ng-click="ok(cd)" ng-disabled="colDefForm.$invalid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
    </div>
  </form>
</script>

<!-- Nested tags template -->
<script type="text/ng-template" id="targets_renderer.html">
  <div ui-tree-handle class="tree-node tree-node-content">
    <button type="button" class="btn btn-box-tool btn-xs" ng-if="tag.targets && tag.targets.length > 0" data-nodrag ng-click="toggle(this)">
      <i class="glyphicon" ng-class="{'glyphicon-chevron-right': collapsed,'glyphicon-chevron-down': !collapsed}"></i></button>
    <div class="tools pull-right">
      <button class="btn btn-box-tool" uib-tooltip="Add new" data-nodrag ng-click="addTarget(this)">
        <i class="glyphicon glyphicon-plus"></i></button>
      <button type="button" class="btn btn-box-tool" uib-tooltip="Delete" data-nodrag ng-click="remove(this)">
        <i class="glyphicon glyphicon-remove"></i></button>
    </div>
    {{tag.label}}
  </div>
  <ol ui-tree-nodes="" ng-model="tag.targets" ng-class="{hidden: collapsed}">
    <li ng-repeat="tag in tag.targets" ui-tree-node ng-include="'targets_renderer.html'">
    </li>
  </ol>
</script>

<script type="text/ng-template" id="edit-property.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cancel()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Edit Property</h4>
  </div>
  <form name="propertyForm" ng-submit="ok(property)">
    <div class="modal-body">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="source">Source</label>
            <select id="source" name="source" class="form-control" ng-model="property.source"
                    ng-options="col as col for (col,val) in columns" ng-change="setProperties(property.source)">
              <option value='' disabled selected>{{column}}</option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="prTarget">Set as</label>
            <input id="prTarget" name="target" type="text" class="form-control" ng-model="property.target"/>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="pValue">Value: </label>
            <textarea id="pValue" class="form-control" ng-model="property.value"></textarea>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="pDataType" class="col-sm-3 control-label">Data Type: </label>
            <div class="col-sm-9">
              <select id="pDataType" class="form-control" ng-model="property.dataType" ng-options="dt as dt for dt in dataTypes">
              </select>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <div class="checkbox">
              <label>
                <input type="checkbox" id="storeNull" name="storeNull" ng-model="property.storeNull"> <b>Store null</b>
              </label>
            </div>
          </div>
        </div>
        <div class="col-md-6" ng-show="property.dataType==='date'">
          <div class="form-group">
            <label for="pDateFormat" class="col-sm-3 control-label">Date Format: </label>
            <div class="col-sm-9">
              <input type="text" id="pDateFormat" class="form-control" ng-model="property.dateFormat" uib-typeahead="df for df in ['Automatic','timestamp','epoc']" uib-tooltip="Automatic, timestamp, epoc or cusom (like 'yyyy-MM-dd)" ng-required="property.dataType==='date'">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary" ng-click="ok(property)" ng-disabled="!propertyForm.$valid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
      <button type="button" class="btn btn-default pull-left" ng-click="cancel()">Cancel</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="create-column.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="close()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Create Column</h4>
  </div>
  <form name="column" class="form-horizontal" ng-submit="ok(obj)">
    <div class="modal-body">
      <div class="row">
        <div class="form-group">
          <label for="colname" class="col-sm-3 control-label">Name: </label>
          <div class="col-sm-8" ng-class="{'has-error': (!unique(obj.name) || column.colName.$invalid) && !column.colName.$pristine}">
            <input id="colname" name="colName" type="text" class="form-control" ng-model="obj.name" required autofocus
                   uib-tooltip="Name is not unique!" tooltip-enable="!unique(obj.name) && !column.colName.$pristine"/>
          </div>
        </div>
        <div class="form-group">
          <label for="expr-value" class="col-sm-3 control-label">Expression</label>
          <div class="col-sm-8">
            <textarea id="expr-value" name="exprValue" class="form-control code" ng-model="obj.value" msd-elastic></textarea>
          </div>
        </div>
        <div class="form-group">
          <label for="coltype" class="col-sm-3 control-label">Data Type</label>
          <div class="col-sm-6">
            <select id="coltype" name="colType" class="form-control" ng-model="obj.dataType" ng-options="t as t for t in ['string','number','date']"></select>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary"  ng-click="ok(obj)" ng-disabled="column.$invalid || !unique(obj.name)"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
      <button type="button" class="btn btn-default pull-left" ng-click="close()">Cancel</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="create-tag.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cancel()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Create New Tag</h4>
  </div>
  <form name="newTag" role="form" class="form-horizontal" ng-submit="ok(newTag.$valid)" novalidate>
    <div class="modal-body">
      <div class="form-group">
        <label for="name" class="col-sm-3 control-label">Name: </label>
        <div class="col-sm-8">
          <textarea id="name" name="name" class="form-control" ng-model="elem.name" rows="1" autofocus></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="code" class="col-sm-3 control-label">Code: </label>
        <div class="col-sm-8">
          <textarea id="code" name="code" class="form-control" ng-model="elem.code" ng-class="{'has-error': newTag.code.$invalid && !newTag.code.$pristine}" rows="1" required></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="tagLabel" class="col-sm-3 control-label">Label: </label>
        <div class="col-sm-8">
          <textarea id="tagLabel" name="label" class="form-control" ng-model="elem.label" ng-class="{'has-error': newTag.label.$invalid && !newTag.label.$pristine}" rows="1" required></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="relationship" class="col-sm-3 control-label">Relationship: </label>
        <div class="col-sm-8">
          <textarea id="relationship" name="relationship" class="form-control" ng-model="elem.relationship" rows="1"></textarea>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-offset-3 col-sm-3">
          <div class="checkbox">
            <label>
              <input type="checkbox" id="reverse" name="reverse" ng-model="elem.reverse"> <b>Reverse</b>
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="active" class="col-sm-3 control-label">Connected to: </label>
        <div class="col-sm-8">
          <select id="active" name="active" class="form-control" ng-options="t.label as t.label for t in canConnect" ng-model="active"></select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default pull-left" ng-click="cancel('cancel')">Cancel</button>
      <button type="submit" class="btn btn-primary" ng-disabled="newTag.$invalid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="create-target.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cancel()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Connect Tag</h4>
  </div>
  <form name="targetForm" role="form" class="form-horizontal" ng-submit="ok(targetForm.$valid)" novalidate>
    <div class="modal-body">

      <h4>Choose Tag to target:</h4>
      <div class="form-group">
        <label for="existing" class="col-sm-3 control-label">Target: </label>
        <div class="col-sm-8">
          <div class="input-group">
            <select id="existing" name="existing" class="form-control" ng-options="t as t.label for t in canConnect" ng-model="target" ng-change="checkElem()"></select>
            <span class="input-group-btn">
              <button type="button" class="btn btn-default" ng-click="target=null"><i class="fa fa-trash"></i></button>
            </span>
          </div>
        </div>
      </div>

      <h4>Or create a New one:</h4>
      <div class="form-group">
        <label for="tgtName" class="col-sm-3 control-label">Name: </label>
        <div class="col-sm-8">
          <textarea id="tgtName" name="name" class="form-control" ng-model="elem.name" rows="1" ng-disabled="target" ng-required="!target" autofocus></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="tgtCode" class="col-sm-3 control-label">Code: </label>
        <div class="col-sm-8">
          <textarea id="tgtCode" name="code" class="form-control" ng-model="elem.code" ng-class="{'has-error': targetForm.code.$invalid && !targetForm.code.$pristine}" rows="1" ng-disabled="target" ng-required="!target"></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="tgtLabel" class="col-sm-3 control-label">Label: </label>
        <div class="col-sm-8">
          <textarea id="tgtLabel" name="label" class="form-control" ng-model="elem.label" ng-class="{'has-error': targetForm.label.$invalid && !targetForm.label.$pristine}" rows="1" ng-disabled="target" ng-required="!target"></textarea>
        </div>
      </div>
      <h4>Details:</h4>
      <div class="form-group">
        <label for="tgtRelationship" class="col-sm-3 control-label">Relationship: </label>
        <div class="col-sm-6">
          <textarea id="tgtRelationship" name="relationship" class="form-control" ng-model="rel.relationship" rows="1"></textarea>
        </div>
        <div class="col-sm-3">
          <div class="checkbox">
            <label>
              <input type="checkbox" id="tgtReverse" name="reverse" ng-model="rel.reverse"> <b>Reverse</b>
            </label>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default pull-left" ng-click="cancel('cancel')">Cancel</button>
      <button type="submit" class="btn btn-primary" ng-disabled="targetForm.$invalid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="create-entitylink.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="close()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Create Entity Link</h4>
  </div>
  <form name="elink" class="form-horizontal" ng-submit="ok(obj)">
    <div class="modal-body">
      <div class="row">
        <div class="form-group">
          <label class="col-sm-3 control-label">Fortress: </label>
          <div class="col-sm-8" ng-class="{'has-error': elink.fortress.$invalid && !elink.fortress.$pristine}">
            <fortress-input name="fortress" model="obj.fortress" required autofocus></fortress-input>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label">Document Name: </label>
          <div class="col-sm-8" ng-class="{'has-error': elink.docname.$invalid && !elink.docname.$pristine}">
            <doctype-input name="docname" model="obj.documentName" fortress="obj.fortress" required></doctype-input>
          </div>
        </div>
        <div class="form-group">
          <label for="relname" class="col-sm-3 control-label">Relationship: </label>
          <div class="col-sm-8" ng-class="{'has-error': elink.relname.$invalid && !elink.relname.$pristine}">
            <input id="relname" name="relname" type="text" class="form-control" ng-model="obj.relationshipName" required />
          </div>
        </div>
        <div class="form-group">
          <label for="col" class="col-sm-3 control-label">Source Datacolumn</label>
          <div class="col-sm-6" ng-class="{'has-error': elink.col.$invalid && !elink.col.$pristine}">
            <select id="col" name="col" class="form-control" ng-model="obj.col" ng-options="c for c in colDefs" required></select>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary" ng-click="ok(obj)" ng-disabled="elink.$invalid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
      <button type="button" class="btn btn-default pull-left" ng-click="close()">Cancel</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="create-alias.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="close()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Create Alias</h4>
  </div>
  <form name="aliasForm" class="form-horizontal" ng-submit="ok(obj)">
    <div class="modal-body">
      <div class="row">
        <div class="form-group">
          <label for="alias-code" class="col-sm-3 control-label">Code: </label>
          <div class="col-sm-8" ng-class="{'has-error': aliasForm.code.$invalid && !aliasForm.code.$pristine}">
            <input id="alias-code" name="code" type="text" class="form-control" ng-model="obj.code" required autofocus/>
          </div>
        </div>
        <div class="form-group">
          <label for="description" class="col-sm-3 control-label">Description: </label>
          <div class="col-sm-8" ng-class="{'has-error': aliasForm.description.$invalid && !aliasForm.description.$pristine}">
            <input id="description" name="description" type="text" class="form-control" ng-model="obj.description" required />
          </div>
        </div>

        <div class="form-group">
          <label for="aliased" class="col-sm-3 control-label">Tag</label>
          <div class="col-sm-6" ng-class="{'has-error': aliasForm.tag.$invalid && !aliasForm.tag.$pristine}">
            <select id="aliased" name="tag" class="form-control" ng-model="obj.tag" ng-options="t as t.label for t in tags" required></select>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary" ng-click="ok(obj)" ng-disabled="aliasForm.$invalid"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
      <button type="button" class="btn btn-default pull-left" ng-click="close()">Cancel</button>
    </div>
  </form>
</script>

<script type="text/ng-template" id="link-tags.html">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="close()">
      <span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Create Tag Relationship</h4>
  </div>
  <form name="relationshipForm" class="form-horizontal" ng-submit="ok(obj)">
    <div class="modal-body">
      <div class="row">
        <div class="col-md-12"><h4>Tag
          <span class="label bg-yellow">{{modalOptions.source.label}}</span> is targeting tag <span class="label bg-yellow">{{modalOptions.target.label}}</span>
          </h4>
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="tag-relationship" class="col-sm-3 control-label">Relationship name: </label>
          <div class="col-sm-6">
            <input id="tag-relationship" name="code" type="text" class="form-control" ng-model="obj.relationship" autofocus/>
          </div>

          <div class="col-sm-3">
            <div class="checkbox">
              <label>
                <input type="checkbox" id="reverse-rel" name="reverse" ng-model="obj.reverse"> <b>Reverse</b>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary"><i class="fa fa-bolt"></i>&nbsp; Ok</button>
      <button type="button" class="btn btn-default pull-left" ng-click="close()">Cancel</button>
    </div>
  </form>
</script>
